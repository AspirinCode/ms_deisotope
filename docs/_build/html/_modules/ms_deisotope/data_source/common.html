
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>ms_deisotope.data_source.common &#8212; ms_deisotope  documentation</title>
    <link rel="stylesheet" href="../../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
      <div class="header" role="banner"><img class="rightlogo" src="../../../_static/logo.svg" alt="Logo"/><h1 class="heading"><a href="../../../index.html">
          <span>ms_deisotope  documentation</span></a></h1>
        <h2 class="heading"><span>ms_deisotope.data_source.common</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for ms_deisotope.data_source.common</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">weakref</span> <span class="k">import</span> <span class="n">WeakValueDictionary</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">ms_peak_picker</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">pick_peaks</span><span class="p">,</span> <span class="n">reprofile</span><span class="p">,</span> <span class="n">average_signal</span><span class="p">,</span>
    <span class="n">scan_filter</span><span class="p">,</span> <span class="n">PeakIndex</span><span class="p">,</span> <span class="n">PeakSet</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">..averagine</span> <span class="k">import</span> <span class="n">neutral_mass</span><span class="p">,</span> <span class="n">mass_charge_ratio</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="k">import</span> <span class="n">Constant</span><span class="p">,</span> <span class="n">add_metaclass</span><span class="p">,</span> <span class="n">decimal_shift</span>
<span class="kn">from</span> <span class="nn">..deconvolution</span> <span class="k">import</span> <span class="n">deconvolute_peaks</span>

<span class="kn">from</span> <span class="nn">.metadata.instrument_components</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Component</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">all_components</span><span class="p">,</span>
    <span class="n">ComponentGroup</span><span class="p">,</span> <span class="n">InstrumentInformation</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">.metadata.file_information</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">FileInformation</span><span class="p">,</span> <span class="n">SourceFile</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">.metadata.scan_traits</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">IsolationWindow</span><span class="p">,</span>
    <span class="n">ScanAcquisitionInformation</span><span class="p">,</span>
    <span class="n">ScanEventInformation</span><span class="p">,</span>
    <span class="n">ScanWindow</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">.metadata.activation</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">ActivationInformation</span><span class="p">,</span> <span class="n">MultipleActivationInformation</span><span class="p">,</span>
    <span class="n">dissociation_methods_map</span> <span class="k">as</span> <span class="n">dissociation_methods</span><span class="p">,</span>
    <span class="n">HCD</span><span class="p">,</span> <span class="n">CID</span><span class="p">,</span> <span class="n">ETD</span><span class="p">,</span> <span class="n">ECD</span><span class="p">,</span> <span class="n">UnknownDissociation</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">..utils</span> <span class="k">import</span> <span class="n">draw_raw</span><span class="p">,</span> <span class="n">draw_peaklist</span><span class="p">,</span> <span class="n">annotate_scan</span> <span class="k">as</span> <span class="n">_annotate_precursors</span>
    <span class="n">has_plot</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">has_plot</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="ScanBunch"><a class="viewcode-back" href="../../../data_source/common_scan.html#ms_deisotope.data_source.common.ScanBunch">[docs]</a><span class="k">class</span> <span class="nc">ScanBunch</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;ScanBunch&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;precursor&quot;</span><span class="p">,</span> <span class="s2">&quot;products&quot;</span><span class="p">])):</span>
    <span class="sd">&quot;&quot;&quot;Represents a single MS1 scan and all MSn scans derived from it</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    precursor: :class:`.Scan`</span>
<span class="sd">        A single MS1 scan which may have undergone MSn</span>
<span class="sd">    products: list</span>
<span class="sd">        A list of 0 or more :class:`Scan` objects which were derived</span>
<span class="sd">        from :attr:`precursor` or another element of this list derived</span>
<span class="sd">        from it.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">inst</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ScanBunch</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">_id_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">inst</span><span class="o">.</span><span class="n">precursor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inst</span><span class="o">.</span><span class="n">_id_map</span><span class="p">[</span><span class="n">inst</span><span class="o">.</span><span class="n">precursor</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">precursor</span>
        <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">inst</span><span class="o">.</span><span class="n">products</span><span class="p">:</span>
            <span class="n">inst</span><span class="o">.</span><span class="n">_id_map</span><span class="p">[</span><span class="n">scan</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">scan</span>
        <span class="k">return</span> <span class="n">inst</span>

<div class="viewcode-block" id="ScanBunch.precursor_for"><a class="viewcode-back" href="../../../data_source/common_scan.html#ms_deisotope.data_source.common.ScanBunch.precursor_for">[docs]</a>    <span class="k">def</span> <span class="nf">precursor_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the precursor :class:`Scan` instance</span>
<span class="sd">        for the given scan object</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scan : Scan</span>
<span class="sd">            The MSn scan to look for the MSn-1 scan for</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Scan</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">scan</span><span class="o">.</span><span class="n">precursor_information</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scan_id</span> <span class="o">=</span> <span class="n">scan</span><span class="o">.</span><span class="n">precursor_information</span><span class="o">.</span><span class="n">precursor_scan_id</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scan_by_id</span><span class="p">(</span><span class="n">scan_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">get_scan_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id_map</span><span class="p">[</span><span class="n">scan_id</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">annotate_precursors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nperrow</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_annotate_precursors</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">precursor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">products</span><span class="p">,</span> <span class="n">nperrow</span><span class="o">=</span><span class="n">nperrow</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_repr_pretty_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="k">if</span> <span class="n">cycle</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;ScanBunch(...)&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;ScanBunch(</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">p</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">p</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;precursor=</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
                <span class="n">p</span><span class="o">.</span><span class="n">pretty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">precursor</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">p</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;,</span><span class="se">\n</span><span class="s2">products=</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
                <span class="n">p</span><span class="o">.</span><span class="n">pretty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">products</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">precursor</span><span class="o">.</span><span class="n">pack</span><span class="p">(),</span> <span class="p">[</span>
            <span class="n">p</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">products</span>
        <span class="p">])</span></div>


<div class="viewcode-block" id="RawDataArrays"><a class="viewcode-back" href="../../../data_source/common_scan.html#ms_deisotope.data_source.common.RawDataArrays">[docs]</a><span class="k">class</span> <span class="nc">RawDataArrays</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;RawDataArrays&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">,</span> <span class="s1">&#39;intensity&#39;</span><span class="p">])):</span>
    <span class="sd">&quot;&quot;&quot;Represent the m/z and intensity arrays associated with a raw</span>
<span class="sd">    mass spectrum.</span>

<span class="sd">    Supports scaling and summing, as well as low level m/z search.</span>

<span class="sd">    Thin wrapper around a ``namedtuple``, so this object supports</span>
<span class="sd">    the same interfaces as a tuple.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    mz: np.ndarray</span>
<span class="sd">        The m/z axis of a mass spectrum</span>
<span class="sd">    intensity: np.ndarray</span>
<span class="sd">        The intensity measured at the corresponding m/z of a mass spectrum</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RawDataArrays.plot"><a class="viewcode-back" href="../../../data_source/common_scan.html#ms_deisotope.data_source.common.RawDataArrays.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Draw the profile spectrum described by the</span>
<span class="sd">        contained arrays.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ax: :class:`matplotlib._axes.Axes`</span>
<span class="sd">            The figure axes onto which to draw the plot. If not provided,</span>
<span class="sd">            this will default to the current figure interactively.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            All keywords are forwarded to :meth:`plot` on ``ax``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`matplotlib._axes.Axes`</span>
<span class="sd">            The axes drawn on</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">draw_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">other</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">other</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__div__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span> <span class="o">/</span> <span class="n">d</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">mz</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">mz</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">intensity</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">*</span><span class="n">average_signal</span><span class="p">([</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">]))</span> <span class="o">*</span> <span class="mi">2</span>

<div class="viewcode-block" id="RawDataArrays.find_mz"><a class="viewcode-back" href="../../../data_source/common_scan.html#ms_deisotope.data_source.common.RawDataArrays.find_mz">[docs]</a>    <span class="k">def</span> <span class="nf">find_mz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mz</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the nearest index to the query ``mz``</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mz : float</span>
<span class="sd">            The m/z value to search for</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            The index nearest to the query m/z</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">)</span>
        <span class="n">lo</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">hi</span> <span class="o">=</span> <span class="n">n</span>

        <span class="k">while</span> <span class="n">hi</span> <span class="o">!=</span> <span class="n">lo</span><span class="p">:</span>
            <span class="n">mid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">hi</span> <span class="o">+</span> <span class="n">lo</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">[</span><span class="n">mid</span><span class="p">]</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">mz</span>
            <span class="k">if</span> <span class="n">hi</span> <span class="o">-</span> <span class="n">lo</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">mid</span>
            <span class="k">elif</span> <span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">hi</span> <span class="o">=</span> <span class="n">mid</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lo</span> <span class="o">=</span> <span class="n">mid</span>
        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="RawDataArrays.between_mz"><a class="viewcode-back" href="../../../data_source/common_scan.html#ms_deisotope.data_source.common.RawDataArrays.between_mz">[docs]</a>    <span class="k">def</span> <span class="nf">between_mz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a slice of the arrays between ``low`` and ``high``</span>
<span class="sd">        m/z</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        low : float</span>
<span class="sd">            The lower bound m/z</span>
<span class="sd">        high : float</span>
<span class="sd">            The upper bound m/z</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`.RawDataArrays`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_mz</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_mz</span><span class="p">(</span><span class="n">high</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">])</span></div></div>


<span class="n">DEFAULT_CHARGE_WHEN_NOT_RESOLVED</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">ChargeNotProvided</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="s2">&quot;ChargeNotProvided&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="ScanDataSource"><a class="viewcode-back" href="../../../data_source/common_reader.html#ms_deisotope.data_source.common.ScanDataSource">[docs]</a><span class="nd">@add_metaclass</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ScanDataSource</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An Abstract Base Class describing an object</span>
<span class="sd">    which can provide a consistent set of accessors</span>
<span class="sd">    for a particular format of mass spectrometry data.</span>

<span class="sd">    Data files come in many shapes and sizes, with different</span>
<span class="sd">    underlying structures. This class provides an API that</span>
<span class="sd">    should make features as consistent as possible to clients</span>
<span class="sd">    of :class:`Scan` objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_scan_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns raw data arrays for m/z and intensity</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scan : Mapping</span>
<span class="sd">            The underlying scan information storage,</span>
<span class="sd">            usually a `dict`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mz: np.array</span>
<span class="sd">            An array of m/z values for this scan</span>
<span class="sd">        intensity: np.array</span>
<span class="sd">            An array of intensity values for this scan</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_precursor_information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns information about the precursor ion,</span>
<span class="sd">        if any, that this scan was derived form.</span>

<span class="sd">        Returns `None` if this scan has no precursor ion</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scan : Mapping</span>
<span class="sd">            The underlying scan information storage,</span>
<span class="sd">            usually a `dict`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        PrecursorInformation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_scan_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a verbose name for this scan, if one</span>
<span class="sd">        were stored in the file. Usually includes both the</span>
<span class="sd">        scan&#39;s id string, as well as information about the</span>
<span class="sd">        original file and format.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scan : Mapping</span>
<span class="sd">            The underlying scan information storage,</span>
<span class="sd">            usually a `dict`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_scan_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the scan&#39;s id string, a unique</span>
<span class="sd">        identifier for this scan in the context of</span>
<span class="sd">        the data file it is recordered in</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scan : Mapping</span>
<span class="sd">            The underlying scan information storage,</span>
<span class="sd">            usually a `dict`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_scan_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the base 0 offset from the start</span>
<span class="sd">        of the data file in number of scans to reach</span>
<span class="sd">        this scan.</span>

<span class="sd">        If the original format does not natively include</span>
<span class="sd">        an index value, this value may be computed from</span>
<span class="sd">        the byte offset index.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scan : Mapping</span>
<span class="sd">            The underlying scan information storage,</span>
<span class="sd">            usually a `dict`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_ms_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the degree of exponential fragmentation</span>
<span class="sd">        used to produce this scan. 1 refers to a survey scan</span>
<span class="sd">        of unfragmented ions, 2 refers to a tandem scan derived</span>
<span class="sd">        from an ms level 1 ion, and so on.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scan : Mapping</span>
<span class="sd">            The underlying scan information storage,</span>
<span class="sd">            usually a `dict`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_scan_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the time in minutes from the start of data</span>
<span class="sd">        acquisition to when this scan was acquired.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scan : Mapping</span>
<span class="sd">            The underlying scan information storage,</span>
<span class="sd">            usually a `dict`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_is_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns whether the scan contains profile data (`True`)</span>
<span class="sd">        or centroided data (`False`).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scan : Mapping</span>
<span class="sd">            The underlying scan information storage,</span>
<span class="sd">            usually a `dict`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_polarity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns whether this scan was acquired in positive mode (+1)</span>
<span class="sd">        or negative mode (-1).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scan : Mapping</span>
<span class="sd">            The underlying scan information storage,</span>
<span class="sd">            usually a `dict`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_activation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns information about the activation method used to</span>
<span class="sd">        produce this scan, if any.</span>

<span class="sd">        Returns `None` for MS1 scans</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scan : Mapping</span>
<span class="sd">            The underlying scan information storage,</span>
<span class="sd">            usually a `dict`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ActivationInformation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_acquisition_information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_isolation_window</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_instrument_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_annotations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">()</span></div>


<div class="viewcode-block" id="ScanIterator"><a class="viewcode-back" href="../../../data_source/common_reader.html#ms_deisotope.data_source.common.ScanIterator">[docs]</a><span class="nd">@add_metaclass</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ScanIterator</span><span class="p">(</span><span class="n">ScanDataSource</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An Abstract Base Class that extends ScanDataSource</span>
<span class="sd">    with additional requirements that enable clients of the</span>
<span class="sd">    class to treat the object as an iterator over the underlying</span>
<span class="sd">    data file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">iteration_mode</span> <span class="o">=</span> <span class="s1">&#39;group&#39;</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_make_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Scan</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_make_default_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

<div class="viewcode-block" id="ScanIterator.make_iterator"><a class="viewcode-back" href="../../../data_source/common_reader.html#ms_deisotope.data_source.common.ScanIterator.make_iterator">[docs]</a>    <span class="k">def</span> <span class="nf">make_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grouped</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Configure the iterator&#39;s behavior.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        iterator : Iterator, optional</span>
<span class="sd">            The iterator to manipulate. If missing, the default</span>
<span class="sd">            iterator will be used.</span>
<span class="sd">        grouped : bool, optional</span>
<span class="sd">            Whether the iterator should be grouped and produce :class:`.ScanBunch` objects</span>
<span class="sd">            or single :class:`.Scan`. Defaults to True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">grouped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_producer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scan_group_iterator</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iteration_mode</span> <span class="o">=</span> <span class="s1">&#39;group&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_producer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_scan_iterator</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iteration_mode</span> <span class="o">=</span> <span class="s1">&#39;single&#39;</span></div>

    <span class="k">def</span> <span class="nf">_make_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">scan</span><span class="o">.</span><span class="n">id</span>

    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_single_scan_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterator</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">iterator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">iterator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_default_iterator</span><span class="p">()</span>

        <span class="n">_make_scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_scan</span>

        <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
            <span class="n">packed</span> <span class="o">=</span> <span class="n">_make_scan</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate</span><span class="p">(</span><span class="n">packed</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scan_cache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_cache_key</span><span class="p">(</span><span class="n">packed</span><span class="p">)]</span> <span class="o">=</span> <span class="n">packed</span>
            <span class="k">yield</span> <span class="n">packed</span>

    <span class="k">def</span> <span class="nf">_scan_group_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterator</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">iterator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">iterator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_default_iterator</span><span class="p">()</span>
        <span class="n">precursor_scan</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">product_scans</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">current_level</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">_make_scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_scan</span>

        <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
            <span class="n">packed</span> <span class="o">=</span> <span class="n">_make_scan</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate</span><span class="p">(</span><span class="n">packed</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scan_cache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_cache_key</span><span class="p">(</span><span class="n">packed</span><span class="p">)]</span> <span class="o">=</span> <span class="n">packed</span>
            <span class="k">if</span> <span class="n">packed</span><span class="o">.</span><span class="n">ms_level</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># inceasing ms level</span>
                <span class="k">if</span> <span class="n">current_level</span> <span class="o">&lt;</span> <span class="n">packed</span><span class="o">.</span><span class="n">ms_level</span><span class="p">:</span>
                    <span class="n">current_level</span> <span class="o">=</span> <span class="n">packed</span><span class="o">.</span><span class="n">ms_level</span>
                <span class="c1"># decreasing ms level</span>
                <span class="k">elif</span> <span class="n">current_level</span> <span class="o">&gt;</span> <span class="n">packed</span><span class="o">.</span><span class="n">ms_level</span><span class="p">:</span>
                    <span class="n">current_level</span> <span class="o">=</span> <span class="n">packed</span><span class="o">.</span><span class="n">ms_level</span>
                <span class="n">product_scans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">packed</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">packed</span><span class="o">.</span><span class="n">ms_level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">current_level</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">precursor_scan</span><span class="o">.</span><span class="n">product_scans</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">product_scans</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">ScanBunch</span><span class="p">(</span><span class="n">precursor_scan</span><span class="p">,</span> <span class="n">product_scans</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">precursor_scan</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">precursor_scan</span><span class="o">.</span><span class="n">product_scans</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">product_scans</span><span class="p">)</span>
                        <span class="k">yield</span> <span class="n">ScanBunch</span><span class="p">(</span><span class="n">precursor_scan</span><span class="p">,</span> <span class="n">product_scans</span><span class="p">)</span>
                <span class="n">precursor_scan</span> <span class="o">=</span> <span class="n">packed</span>
                <span class="n">product_scans</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not interpret MS Level </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">packed</span><span class="o">.</span><span class="n">ms_level</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">precursor_scan</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">ScanBunch</span><span class="p">(</span><span class="n">precursor_scan</span><span class="p">,</span> <span class="n">product_scans</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_scan_cleared</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scan_cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_cache_key</span><span class="p">(</span><span class="n">scan</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">initialize_scan_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scan_cache</span> <span class="o">=</span> <span class="n">WeakValueDictionary</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scan_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scan_cache</span>

    <span class="nd">@scan_cache</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">scan_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scan_cache</span> <span class="o">=</span> <span class="n">value</span></div>


<div class="viewcode-block" id="RandomAccessScanSource"><a class="viewcode-back" href="../../../data_source/common_reader.html#ms_deisotope.data_source.common.RandomAccessScanSource">[docs]</a><span class="nd">@add_metaclass</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RandomAccessScanSource</span><span class="p">(</span><span class="n">ScanIterator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An Abstract Base Class that extends ScanIterator</span>
<span class="sd">    with additional requirements that the implementation support</span>
<span class="sd">    random access to individual scans. This should be doable by unique</span>
<span class="sd">    identifier, sequential index, or by scan time.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RandomAccessScanSource.get_scan_by_id"><a class="viewcode-back" href="../../../data_source/common_reader.html#ms_deisotope.data_source.common.RandomAccessScanSource.get_scan_by_id">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_scan_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve the scan object for the specified scan id.</span>

<span class="sd">        If the scan object is still bound and in memory somewhere,</span>
<span class="sd">        a reference to that same object will be returned. Otherwise,</span>
<span class="sd">        a new object will be created.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scan_id : str</span>
<span class="sd">            The unique scan id value to be retrieved</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Scan</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="RandomAccessScanSource.get_scan_by_time"><a class="viewcode-back" href="../../../data_source/common_reader.html#ms_deisotope.data_source.common.RandomAccessScanSource.get_scan_by_time">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_scan_by_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve the scan object for the specified scan time.</span>

<span class="sd">        This internally calls :meth:`get_scan_by_id` which will</span>
<span class="sd">        use its cache.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        time : float</span>
<span class="sd">            The time to get the nearest scan from</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Scan</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="RandomAccessScanSource.get_scan_by_index"><a class="viewcode-back" href="../../../data_source/common_reader.html#ms_deisotope.data_source.common.RandomAccessScanSource.get_scan_by_index">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_scan_by_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve the scan object for the specified scan index.</span>

<span class="sd">        This internally calls :meth:`get_scan_by_id` which will</span>
<span class="sd">        use its cache.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index: int</span>
<span class="sd">            The index to get the scan for</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Scan</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="RandomAccessScanSource.start_from_scan"><a class="viewcode-back" href="../../../data_source/common_reader.html#ms_deisotope.data_source.common.RandomAccessScanSource.start_from_scan">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">start_from_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">require_ms1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">grouped</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Reconstruct an iterator which will start from the scan matching one of ``scan_id``,</span>
<span class="sd">        ``rt``, or ``index``. Only one may be provided.</span>

<span class="sd">        After invoking this method, the iterator this object wraps will be changed to begin</span>
<span class="sd">        yielding scan bunchs (or single scans if ``grouped`` is ``False``).</span>

<span class="sd">        This method will trigger several random-access operations, making it prohibitively</span>
<span class="sd">        expensive for normally compressed files.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        scan_id: str, optional</span>
<span class="sd">            Start from the scan with the specified id.</span>
<span class="sd">        rt: float, optional</span>
<span class="sd">            Start from the scan nearest to specified time (in minutes) in the run. If no</span>
<span class="sd">            exact match is found, the nearest scan time will be found, rounded up.</span>
<span class="sd">        index: int, optional</span>
<span class="sd">            Start from the scan with the specified index.</span>
<span class="sd">        require_ms1: bool, optional</span>
<span class="sd">            Whether the iterator must start from an MS1 scan. True by default.</span>
<span class="sd">        grouped: bool, optional</span>
<span class="sd">            whether the iterator should yield scan bunches or single scans. True by default.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_locate_ms1_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
        <span class="k">while</span> <span class="n">scan</span><span class="o">.</span><span class="n">ms_level</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scan</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scan_by_index</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scan</span><span class="o">.</span><span class="n">ms_level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">scan</span>
        <span class="k">while</span> <span class="n">scan</span><span class="o">.</span><span class="n">ms_level</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scan_by_index</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Cannot locate MS1 Scan&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scan</span>

    <span class="k">def</span> <span class="nf">find_previous_ms1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_index</span><span class="p">):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">start_index</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scan_by_index</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">scan</span><span class="o">.</span><span class="n">ms_level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">scan</span>
                <span class="n">index</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">find_next_ms1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_index</span><span class="p">):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">start_index</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scan_by_index</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">scan</span><span class="o">.</span><span class="n">ms_level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">scan</span>
                <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve the scan object for the specified scan index.</span>

<span class="sd">        This internally calls :meth:`get_scan_by_index` but supports</span>
<span class="sd">        slicing and negative indexing.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index: int</span>
<span class="sd">            The index to get the scan for</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Scan</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">scans</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
                <span class="n">scans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">scans</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="n">i</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scan_by_index</span><span class="p">(</span><span class="n">i</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">DetachedAccessError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">DataAccessProxy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">attach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>

    <span class="k">def</span> <span class="nf">detach</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">raise_if_detached</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DetachedAccessError</span><span class="p">(</span><span class="s2">&quot;Cannot perform operation. Instance is detached.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_scan_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raise_if_detached</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">get_scan_by_id</span><span class="p">(</span><span class="n">scan_id</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ScanBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">has_ion_mobility</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Check whether this scan has drift time information associated with</span>
<span class="sd">        it.</span>

<span class="sd">        If this scan has been aggregated, it will only check the first scan in</span>
<span class="sd">        the aggregate.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">acq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_information</span>
        <span class="k">if</span> <span class="n">acq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">scan_event</span> <span class="o">=</span> <span class="n">acq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">scan_event</span><span class="o">.</span><span class="n">has_ion_mobility</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">drift_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">acq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_information</span>
        <span class="k">if</span> <span class="n">acq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">scan_event</span> <span class="o">=</span> <span class="n">acq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">scan_event</span><span class="o">.</span><span class="n">drift_time</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scan_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a deep copy of the :class:`Scan` object</span>
<span class="sd">        wrapping the same reference data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`Scan`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ScanBase</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">eq</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_id</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">scan_id</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_time</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">scan_time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-3</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ms_level</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">ms_level</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">eq</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrays</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">arrays</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">eq</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># ProcessedScan doesn&#39;t have an arrays attribute</span>
            <span class="k">pass</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_set</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">peak_set</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">eq</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deconvoluted_peak_set</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">deconvoluted_peak_set</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">eq</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">precursor_information</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">precursor_information</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">eq</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isolation_window</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">isolation_window</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">eq</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_information</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">acquisition_information</span>
            <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">eq</span> <span class="o">=</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">eq</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">eq</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">activation</span>
            <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">eq</span> <span class="o">=</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">eq</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">eq</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">precursor_information</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">precursor_information</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>


<div class="viewcode-block" id="Scan"><a class="viewcode-back" href="../../../data_source/common_scan.html#ms_deisotope.data_source.common.Scan">[docs]</a><span class="k">class</span> <span class="nc">Scan</span><span class="p">(</span><span class="n">ScanBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Container for mass spectral data and associated descriptive information.</span>

<span class="sd">    A :class:`Scan` object is a generic object intended to be created by a :class:`ScanDataSource` and describes</span>
<span class="sd">    a mass spectrum at each level of processing (Profile --&gt; Peak Fitted --&gt; Deconvoluted). The raw object</span>
<span class="sd">    provided by the source is wrapped and queried lazily when an attribute is requested, delegated through</span>
<span class="sd">    :attr:`source`.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    deconvoluted_peak_set : :class:`ms_deisotope.DeconvolutedPeakSet` or None</span>
<span class="sd">        Deconvoluted peaks resulting from charge state deconvolution and deisotoping. Will</span>
<span class="sd">        be `None` if deconvolution has not been done.</span>
<span class="sd">    peak_set : :class:`ms_peak_picker.PeakSet` or None</span>
<span class="sd">        Picked peaks and (possibly) associated raw data points as produced by :meth:`pick_peaks`.</span>
<span class="sd">        Will be `None` if peak picking has not been done.</span>
<span class="sd">    product_scans : list</span>
<span class="sd">        A list of :class:`Scan` instances which were produced by fragmenting ions from this one.</span>
<span class="sd">        This attribute is not guaranteed to be populated depending upon how the scan is loaded.</span>
<span class="sd">    source : :class:`ScanDataSource`</span>
<span class="sd">        The object which produced this scan and which defines the methods for retrieving common</span>
<span class="sd">        attributes from the underlying data structures.</span>
<span class="sd">    precursor_information: :class:`PrecursorInformation` or None</span>
<span class="sd">        Descriptive metadata for the ion which was chosen for fragmentation, and a reference to</span>
<span class="sd">        the precursor scan</span>
<span class="sd">    arrays: :class:`RawDataArrays`</span>
<span class="sd">        A pair of :class:`numpy.ndarray` objects corresponding to the raw m/z and intensity data points</span>
<span class="sd">    id: str</span>
<span class="sd">        The unique identifier for this scan as given by the source</span>
<span class="sd">    title: str</span>
<span class="sd">        The human-readable display string for this scan as shown in some external software</span>
<span class="sd">    ms_level: int</span>
<span class="sd">        The degree of fragmentation performed. 1 corresponds to a MS1 or &quot;Survey&quot; scan, 2 corresponds</span>
<span class="sd">        to MS/MS, and so on. If :attr:`ms_level` &gt; 1, the scan is considered a &quot;tandem scan&quot; or &quot;MS^n&quot; scan</span>
<span class="sd">    scan_time: float</span>
<span class="sd">        The time the scan was acquired during data acquisition. The unit of time will always be minutes.</span>
<span class="sd">    drift_time: float or None</span>
<span class="sd">        The time measured by the ion mobility spectrometer for this scan or frame. This quantity is None</span>
<span class="sd">        if the scan does not have ion mobility information associated with it, which is usually recorded</span>
<span class="sd">        in :attr:`acquisition_information`</span>
<span class="sd">    index: int</span>
<span class="sd">        The integer number indicating how many scans were acquired prior to this scan.</span>
<span class="sd">    is_profile: bool</span>
<span class="sd">        Whether this scan&#39;s raw data points corresponds to a profile scan or whether the raw data was</span>
<span class="sd">        pre-centroided.</span>
<span class="sd">    polarity: int</span>
<span class="sd">        If the scan was acquired in positive mode, the value ``+1``.  If the scan was acquired in negative</span>
<span class="sd">        mode, the value ``-1``. May be used to indicating how to calibrate charge state determination methods.</span>
<span class="sd">    activation: :class:`.ActivationInformation` or None</span>
<span class="sd">        If this scan is an MS^n scan, this attribute will contain information about the process</span>
<span class="sd">        used to produce it from its parent ion.</span>
<span class="sd">    instrument_configuration: :class:`~.InstrumentInformation`</span>
<span class="sd">        The instrument configuration used to acquire this scan.</span>
<span class="sd">    acquisition_information: :class:`.ScanAcquisitionInformation` or None</span>
<span class="sd">        Describes the type of event that produced this scan, as well as the scanning method</span>
<span class="sd">        used.</span>
<span class="sd">    isolation_window: :class:`.IsolationWindow` or None</span>
<span class="sd">        Describes the range of m/z that were isolated from a parent scan to create this scan</span>
<span class="sd">    annotations: dict</span>
<span class="sd">        A set of key-value pairs describing the scan not part of the standard interface</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">peak_set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deconvoluted_peak_set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">product_scans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">product_scans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">product_scans</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">annotations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">annotations</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak_set</span> <span class="o">=</span> <span class="n">peak_set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deconvoluted_peak_set</span> <span class="o">=</span> <span class="n">deconvoluted_peak_set</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_arrays</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_title</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ms_level</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scan_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_precursor_information</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_profile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_polarity</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_activation</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_acquisition_information</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_isolation_window</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_instrument_configuration</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_external_annotations</span> <span class="o">=</span> <span class="n">annotations</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">product_scans</span> <span class="o">=</span> <span class="n">product_scans</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">peak_set</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_set</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deconvoluted_peak_set</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deconvoluted_peak_set</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">product_scans</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_annotations</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">dup</span>

    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrays</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms_level</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_time</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">polarity</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">precursor_information</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_information</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isolation_window</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_profile</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument_configuration</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span>
        <span class="n">_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">del</span> <span class="n">_</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_unload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arrays</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_title</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ms_level</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scan_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_precursor_information</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_profile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_polarity</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_activation</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_acquisition_information</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_isolation_window</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_instrument_configuration</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Scan.clear"><a class="viewcode-back" href="../../../data_source/common_scan.html#ms_deisotope.data_source.common.Scan.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Releases all associated in-memory data and clears the cached</span>
<span class="sd">        attributes.</span>

<span class="sd">        The data reference attribute :attr:`_data` is retained</span>
<span class="sd">        and unchanged.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">_scan_cleared</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unload</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ms_level</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ms_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">_ms_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_level</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_profile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">_is_profile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_profile</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">polarity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_polarity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_polarity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">_polarity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_polarity</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scan_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scan_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scan_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">_scan_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scan_time</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arrays</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arrays</span> <span class="o">=</span> <span class="n">RawDataArrays</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">_scan_arrays</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arrays</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">_scan_title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_title</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">_scan_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scan_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">_scan_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span>

    <span class="nd">@index</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">precursor_information</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms_level</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_precursor_information</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_precursor_information</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">_precursor_information</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_precursor_information</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">activation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms_level</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_activation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">_activation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_activation</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">isolation_window</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms_level</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isolation_window</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_isolation_window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">_isolation_window</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isolation_window</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">acquisition_information</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acquisition_information</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_acquisition_information</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">_acquisition_information</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acquisition_information</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">instrument_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instrument_configuration</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instrument_configuration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">_instrument_configuration</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instrument_configuration</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">annotations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">_annotations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_external_annotations</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span>

    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Scan</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Scan(</span><span class="si">%r</span><span class="s2">, index=</span><span class="si">%d</span><span class="s2">, time=</span><span class="si">%0.4f</span><span class="s2">, ms_level=</span><span class="si">%r%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms_level</span><span class="p">,</span>
            <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">precursor_information</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">precursor_information</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># peak manipulation</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_set</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot iterate over peaks in a scan that has not been &quot;</span>
                             <span class="s2">&quot;centroided. Call `pick_peaks` first.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peak_set</span><span class="p">)</span>

<div class="viewcode-block" id="Scan.has_peak"><a class="viewcode-back" href="../../../data_source/common_scan.html#ms_deisotope.data_source.common.Scan.has_peak">[docs]</a>    <span class="k">def</span> <span class="nf">has_peak</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A wrapper around :meth:`ms_peak_picker.PeakSet.has_peak` to query the</span>
<span class="sd">        :class:`ms_peak_picker.FittedPeak` objects picked for this scan.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mz: float</span>
<span class="sd">            The m/z to search for</span>
<span class="sd">        error_tolerance: float</span>
<span class="sd">            The parts per million mass error tolerance to use</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ms_peak_picker.FittedPeak or None</span>
<span class="sd">            The peak closest to the query m/z within the error tolerance window or None</span>
<span class="sd">            if there are no peaks satisfying the requirements</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError:</span>
<span class="sd">            If the scan has not yet had peaks picked yet</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :meth:`.Scan.pick_peaks`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_set</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot search for peaks in a scan that has not been &quot;</span>
                             <span class="s2">&quot;centroided. Call `pick_peaks` first.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_set</span><span class="o">.</span><span class="n">has_peak</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scan.pick_peaks"><a class="viewcode-back" href="../../../data_source/common_scan.html#ms_deisotope.data_source.common.Scan.pick_peaks">[docs]</a>    <span class="k">def</span> <span class="nf">pick_peaks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A wrapper around :func:`ms_peak_picker.pick_peaks` which will populate the</span>
<span class="sd">        :attr:`peak_set` attribute of this scan.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fit_type : str, optional</span>
<span class="sd">            The name of the peak model to use. One of &quot;quadratic&quot;, &quot;gaussian&quot;, &quot;lorentzian&quot;, or &quot;apex&quot;</span>
<span class="sd">        signal_to_noise_threshold : int, optional</span>
<span class="sd">            Minimum signal-to-noise measurement to accept a peak</span>
<span class="sd">        intensity_threshold : int, optional</span>
<span class="sd">            Minimum intensity measurement to accept a peak</span>
<span class="sd">        threshold_data : bool, optional</span>
<span class="sd">            Whether to apply thresholds to the data</span>
<span class="sd">        target_envelopes : list, optional</span>
<span class="sd">            A sequence of (start m/z, end m/z) pairs, limiting peak picking to only those intervals</span>
<span class="sd">        transforms : list, optional</span>
<span class="sd">            A list of :class:`scan_filter.FilterBase` instances or callable that</span>
<span class="sd">            accepts (mz_array, intensity_array) and returns (mz_array, intensity_array) or</span>
<span class="sd">            `str` matching one of the premade names in `scan_filter.filter_register`</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            Whether to log extra information while picking peaks</span>
<span class="sd">        start_mz : float, optional</span>
<span class="sd">            A minimum m/z value to start picking peaks from</span>
<span class="sd">        stop_mz : float, optional</span>
<span class="sd">            A maximum m/z value to stop picking peaks after</span>
<span class="sd">        *args :</span>
<span class="sd">            Passed along to :func:`ms_peak_picker.pick_peaks`</span>
<span class="sd">        **kwargs :</span>
<span class="sd">            Passed along to :func:`ms_peak_picker.pick_peaks`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Scan</span>
<span class="sd">            Returns self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mzs</span><span class="p">,</span> <span class="n">intensities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrays</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mzs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">peak_set</span> <span class="o">=</span> <span class="n">PeakIndex</span><span class="p">(</span><span class="n">mzs</span><span class="p">,</span> <span class="n">intensities</span><span class="p">,</span> <span class="n">PeakSet</span><span class="p">([]))</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_profile</span><span class="p">:</span>
            <span class="n">peak_mode</span> <span class="o">=</span> <span class="s1">&#39;profile&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">peak_mode</span> <span class="o">=</span> <span class="s1">&#39;centroid&#39;</span>

        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;peak_mode&#39;</span><span class="p">,</span> <span class="n">peak_mode</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">peak_set</span> <span class="o">=</span> <span class="n">pick_peaks</span><span class="p">(</span><span class="n">mzs</span><span class="p">,</span> <span class="n">intensities</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Scan.deconvolute"><a class="viewcode-back" href="../../../data_source/common_scan.html#ms_deisotope.data_source.common.Scan.deconvolute">[docs]</a>    <span class="k">def</span> <span class="nf">deconvolute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A wrapper around :func:`ms_deisotope.deconvolution.deconvolute_peaks`.</span>

<span class="sd">        The scan must have had its peaks picked before it can be deconvoluted.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        decon_config : dict, optional</span>
<span class="sd">            Parameters to use to initialize the deconvoluter instance produced by</span>
<span class="sd">            ``deconvoluter_type``</span>
<span class="sd">        charge_range : tuple of integers, optional</span>
<span class="sd">            The range of charge states to consider.</span>
<span class="sd">        error_tolerance : float, optional</span>
<span class="sd">            PPM error tolerance to use to match experimental to theoretical peaks</span>
<span class="sd">        priority_list : list, optional</span>
<span class="sd">            The set of peaks to target for deconvolution to be able to enforce external</span>
<span class="sd">            constraints on, such as selected precursors for fragmentation.</span>
<span class="sd">        left_search_limit : int, optional</span>
<span class="sd">            The maximum number of neutron shifts to search to the left  (decrease) from</span>
<span class="sd">            each query peak</span>
<span class="sd">        right_search_limit : int, optional</span>
<span class="sd">            The maximum number of neutron shifts to search to the right (increase) from</span>
<span class="sd">            each query peak</span>
<span class="sd">        left_search_limit_for_priorities : int, optional</span>
<span class="sd">            The maximum number of neutron shifts to search to the left (decrease) from</span>
<span class="sd">            each query peak for priority targets</span>
<span class="sd">        right_search_limit_for_priorities : None, optional</span>
<span class="sd">            The maximum number of neutron shifts to search to the right (increase) from</span>
<span class="sd">            each query peak for priority targets</span>
<span class="sd">        charge_carrier : float, optional</span>
<span class="sd">            The mass of the charge carrier. Defaults to PROTON</span>
<span class="sd">        truncate_after : float, optional</span>
<span class="sd">            The percentage of the isotopic pattern to include. Defaults to TRUNCATE_AFTER</span>
<span class="sd">        deconvoluter_type : type or callable, optional</span>
<span class="sd">            A callable returning a deconvoluter. Defaults to :class:`~.AveraginePeakDependenceGraphDeconvoluter`</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Additional keywords passed to :func:`~.deconvolute_peaks`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Scan</span>
<span class="sd">            Returns self</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If :attr:`peak_set` is None, a :class:`ValueError` will be raised</span>
<span class="sd">            indicating that a scan must be centroided before it can be deconvoluted</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :func:`~.deconvolute_peaks`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_set</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot deconvolute a scan that has not been &quot;</span>
                             <span class="s2">&quot;centroided. Call `pick_peaks` first.&quot;</span><span class="p">)</span>
        <span class="n">charge_range</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;charge_range&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polarity</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">max</span><span class="p">(</span><span class="n">charge_range</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">charge_range</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">polarity</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">charge_range</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;charge_range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">charge_range</span>
        <span class="n">decon_results</span> <span class="o">=</span> <span class="n">deconvolute_peaks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peak_set</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deconvoluted_peak_set</span> <span class="o">=</span> <span class="n">decon_results</span><span class="o">.</span><span class="n">peak_set</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="k">def</span> <span class="nf">pack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">precursor_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">precursor_information</span>
        <span class="k">return</span> <span class="n">ProcessedScan</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">precursor_info</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ms_level</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">peak_set</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_set</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deconvoluted_peak_set</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">polarity</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_information</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isolation_window</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instrument_configuration</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">product_scans</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">)</span>

    <span class="c1"># signal transformation</span>

<div class="viewcode-block" id="Scan.reprofile"><a class="viewcode-back" href="../../../data_source/common_scan.html#ms_deisotope.data_source.common.Scan.reprofile">[docs]</a>    <span class="k">def</span> <span class="nf">reprofile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_fwhm</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">model_cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use the picked peaks in :attr:`peak_set` to create a new</span>
<span class="sd">        profile mass spectrum using a peak shape model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        max_fwhm : float, optional</span>
<span class="sd">            Maximum peak width above which peaks will be ignored</span>
<span class="sd">        dx : float, optional</span>
<span class="sd">            The distance between each new point in m/z space in the</span>
<span class="sd">            reprofiled spectrum</span>
<span class="sd">        model_cls : ms_peak_picker.peak_statistics.PeakShapeModel, optional</span>
<span class="sd">            The peak shape model to use to generate the profile data from</span>
<span class="sd">            the centroided peaks. Defaults a Gaussian model</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Scan</span>
<span class="sd">            A shallow copy of this scan with its :attr:`arrays` replaced with</span>
<span class="sd">            the new reprofiled arrays</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            A scan that has not been centroided and is already in profile mode</span>
<span class="sd">            must have its peaks picked before it can be reprofiled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_set</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_profile</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot reprofile a scan that has not been centroided&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_set</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_profile</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pick_peaks</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peak_set</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">arrays</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">arrays</span> <span class="o">=</span> <span class="n">reprofile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peak_set</span><span class="p">,</span> <span class="n">max_fwhm</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">model_cls</span><span class="p">)</span>
        <span class="n">scan</span> <span class="o">=</span> <span class="n">WrappedScan</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">arrays</span><span class="p">,</span>
            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">product_scans</span><span class="p">),</span> <span class="n">is_profile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">annotations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_external_annotations</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scan</span></div>

<div class="viewcode-block" id="Scan.denoise"><a class="viewcode-back" href="../../../data_source/common_scan.html#ms_deisotope.data_source.common.Scan.denoise">[docs]</a>    <span class="k">def</span> <span class="nf">denoise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">region_width</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a shallow copy of the scan with a noise reduction</span>
<span class="sd">        transformation applied.</span>

<span class="sd">        This method uses the scan filter :class:`ms_peak_picker.scan_filter.FTICRBaselineRemoval`</span>
<span class="sd">        which uses the MasSpike noise reduction algorithm.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scale : float, optional</span>
<span class="sd">            The multiplier of the local noise window to remove</span>
<span class="sd">        window_length : float, optional</span>
<span class="sd">            The width (in m/z) of each window</span>
<span class="sd">        region_width : int, optional</span>
<span class="sd">            The width (in m/z) of each region of windows</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Scan</span>
<span class="sd">            The denoised version of this scan</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mzs</span><span class="p">,</span> <span class="n">intensities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrays</span>
        <span class="n">mzs</span> <span class="o">=</span> <span class="n">mzs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">intensities</span> <span class="o">=</span> <span class="n">intensities</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">scan_filter</span><span class="o">.</span><span class="n">FTICRBaselineRemoval</span><span class="p">(</span>
            <span class="n">window_length</span><span class="o">=</span><span class="n">window_length</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">region_width</span><span class="o">=</span><span class="n">region_width</span><span class="p">)</span>
        <span class="n">mzs</span><span class="p">,</span> <span class="n">intensities</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">mzs</span><span class="p">,</span> <span class="n">intensities</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">WrappedScan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                           <span class="p">(</span><span class="n">mzs</span><span class="p">,</span> <span class="n">intensities</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">product_scans</span><span class="p">),</span>
                           <span class="n">annotations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_external_annotations</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">mzs</span><span class="p">,</span> <span class="n">intensities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrays</span>
        <span class="n">mzs</span> <span class="o">=</span> <span class="n">mzs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">intensities</span> <span class="o">=</span> <span class="n">intensities</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">mzs</span><span class="p">,</span> <span class="n">intensities</span> <span class="o">=</span> <span class="n">scan_filter</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">mzs</span><span class="p">,</span> <span class="n">intensities</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">WrappedScan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                           <span class="p">(</span><span class="n">mzs</span><span class="p">,</span> <span class="n">intensities</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">product_scans</span><span class="p">),</span>
                           <span class="n">annotations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_external_annotations</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_average_with</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scans</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">weight_sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">scans</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">scans</span><span class="p">)</span>
        <span class="n">arrays</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scan</span><span class="o">.</span><span class="n">is_profile</span><span class="p">:</span>
                <span class="n">arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">arrays</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">reprofile</span><span class="p">(</span><span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">)</span><span class="o">.</span><span class="n">arrays</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">weight_sigma</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">weight_sigma</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">weight_sigma</span> <span class="o">=</span> <span class="mf">0.025</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_smoothing_weights</span><span class="p">(</span>
                <span class="n">scans</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_time</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">weight_sigma</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">new_arrays</span> <span class="o">=</span> <span class="n">average_signal</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">scan</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">AveragedScan</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">new_arrays</span><span class="p">,</span>
            <span class="n">indices</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">product_scans</span><span class="p">),</span> <span class="n">is_profile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">annotations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_external_annotations</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_adjacent_scans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rt_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">index_interval</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rt_interval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;One of `index_interval` or `rt_interval` must be provided&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms_level</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot average MSn scans at this time&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t average an unbound scan&quot;</span><span class="p">)</span>
        <span class="n">before</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">after</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">index_interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">before</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">current_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">index_interval</span><span class="p">):</span>
                <span class="n">next_scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">find_previous_ms1</span><span class="p">(</span><span class="n">current_index</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">next_scan</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">before</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_scan</span><span class="p">)</span>
                <span class="n">current_index</span> <span class="o">=</span> <span class="n">next_scan</span><span class="o">.</span><span class="n">index</span>
            <span class="n">before</span> <span class="o">=</span> <span class="n">before</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">after</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">current_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">index_interval</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">next_scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">find_next_ms1</span><span class="p">(</span><span class="n">current_index</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">next_scan</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">after</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_scan</span><span class="p">)</span>
                <span class="n">current_index</span> <span class="o">=</span> <span class="n">next_scan</span><span class="o">.</span><span class="n">index</span>
        <span class="k">elif</span> <span class="n">rt_interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reference_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_time</span>
            <span class="n">before</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">current_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span>
            <span class="n">current_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_time</span>
            <span class="k">while</span> <span class="nb">abs</span><span class="p">(</span><span class="n">reference_time</span> <span class="o">-</span> <span class="n">current_time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">rt_interval</span> <span class="ow">and</span> <span class="n">current_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">next_scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">find_previous_ms1</span><span class="p">(</span><span class="n">current_index</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">next_scan</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">before</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_scan</span><span class="p">)</span>
                <span class="n">current_index</span> <span class="o">=</span> <span class="n">next_scan</span><span class="o">.</span><span class="n">index</span>
                <span class="n">current_time</span> <span class="o">=</span> <span class="n">next_scan</span><span class="o">.</span><span class="n">scan_time</span>

            <span class="n">before</span> <span class="o">=</span> <span class="n">before</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">after</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">current_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span>
            <span class="n">current_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_time</span>
            <span class="k">while</span> <span class="nb">abs</span><span class="p">(</span><span class="n">reference_time</span> <span class="o">-</span> <span class="n">current_time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">rt_interval</span> <span class="ow">and</span> <span class="n">current_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">next_scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">find_next_ms1</span><span class="p">(</span><span class="n">current_index</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">next_scan</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">after</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_scan</span><span class="p">)</span>
                <span class="n">current_index</span> <span class="o">=</span> <span class="n">next_scan</span><span class="o">.</span><span class="n">index</span>
                <span class="n">current_time</span> <span class="o">=</span> <span class="n">next_scan</span><span class="o">.</span><span class="n">scan_time</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;One of `index_interval` or `rt_interval` must be provided&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">before</span><span class="p">,</span> <span class="n">after</span>

    <span class="k">def</span> <span class="nf">_compute_smoothing_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scans</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.025</span><span class="p">):</span>
        <span class="n">sigma_sqrd_2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">time_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">scan_time</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">])</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="o">-</span><span class="p">(</span><span class="n">time_array</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma_sqrd_2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">weights</span>

<div class="viewcode-block" id="Scan.average"><a class="viewcode-back" href="../../../data_source/common_scan.html#ms_deisotope.data_source.common.Scan.average">[docs]</a>    <span class="k">def</span> <span class="nf">average</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rt_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">weight_sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Average together multiple scans&#39; raw data arrays to create a composite intensity</span>
<span class="sd">        profile for a common m/z axis.</span>

<span class="sd">        Only MS1 scans will be averaged with this method</span>

<span class="sd">        Either an absolute number of scans before and after can be specified using</span>
<span class="sd">        ``index_interval`` or a time window may be specified using ``rt_interval``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index_interval : int, optional</span>
<span class="sd">            The number of scans preceding and proceding to average with.</span>
<span class="sd">        rt_interval : float, optional</span>
<span class="sd">            The range of time (in minutes) preceding and proceding to</span>
<span class="sd">            look for other scans to average with.</span>
<span class="sd">        dx : float, optional</span>
<span class="sd">            The distance between each point in the generated common m/z axis.</span>
<span class="sd">        weight_sigma : float, optional</span>
<span class="sd">            When this value is not None, scans are weighted according to a</span>
<span class="sd">            gaussian distribution with a $\sigma$ equal to this value</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Scan</span>
<span class="sd">            A shallow copy of this scan with its :attr:`arrays` attribute replaced</span>
<span class="sd">            with the averaged array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="mf">0.01</span>
            <span class="n">default_dx</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default_dx</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">before</span><span class="p">,</span> <span class="n">after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_adjacent_scans</span><span class="p">(</span><span class="n">index_interval</span><span class="p">,</span> <span class="n">rt_interval</span><span class="p">)</span>
        <span class="n">scans</span> <span class="o">=</span> <span class="n">before</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="o">+</span> <span class="n">after</span>
        <span class="n">arrays</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scan</span><span class="o">.</span><span class="n">is_profile</span><span class="p">:</span>
                <span class="n">scan_arrays</span> <span class="o">=</span> <span class="n">scan</span><span class="o">.</span><span class="n">arrays</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scan_arrays</span> <span class="o">=</span> <span class="n">scan</span><span class="o">.</span><span class="n">reprofile</span><span class="p">(</span><span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">)</span><span class="o">.</span><span class="n">arrays</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scan_arrays</span><span class="o">.</span><span class="n">mz</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scan_arrays</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">weight_sigma</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">weight_sigma</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">weight_sigma</span> <span class="o">=</span> <span class="mf">0.025</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_smoothing_weights</span><span class="p">(</span>
                <span class="n">scans</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_time</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">weight_sigma</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">default_dx</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">reference</span> <span class="o">=</span> <span class="n">arrays</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reference</span> <span class="o">=</span> <span class="n">arrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">empirical_dx</span> <span class="o">=</span> <span class="n">decimal_shift</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">reference</span><span class="o">.</span><span class="n">mz</span><span class="p">)))</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">empirical_dx</span><span class="p">)</span>

        <span class="n">new_arrays</span> <span class="o">=</span> <span class="n">average_signal</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">scan</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">AveragedScan</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">new_arrays</span><span class="p">,</span>
            <span class="n">indices</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">product_scans</span><span class="p">),</span> <span class="n">is_profile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">annotations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_external_annotations</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">WrappedScan</span><span class="p">(</span><span class="n">Scan</span><span class="p">):</span>
    <span class="n">overridable_keys</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;_arrays&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_title&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_ms_level&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_scan_time&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_precursor_information&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_index&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_is_profile&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_polarity&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_activation&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_acquisition_information&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_isolation_window&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_instrument_configuration&quot;</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">array_data</span><span class="p">,</span> <span class="n">product_scans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">overrides</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">WrappedScan</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">peak_set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">deconvoluted_peak_set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">annotations</span><span class="o">=</span><span class="n">annotations</span><span class="p">,</span>
            <span class="n">product_scans</span><span class="o">=</span><span class="n">product_scans</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arrays</span> <span class="o">=</span> <span class="n">RawDataArrays</span><span class="p">(</span><span class="o">*</span><span class="n">array_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_overrides</span> <span class="o">=</span> <span class="n">overrides</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">overrides</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">key</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">overridable_keys</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Cannot override attribute </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,))</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrays</span><span class="p">,</span>
            <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">product_scans</span><span class="p">],</span>
            <span class="n">annotations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_external_annotations</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_overrides</span><span class="p">)</span>
        <span class="n">dup</span><span class="o">.</span><span class="n">peak_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_set</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">dup</span><span class="o">.</span><span class="n">deconvoluted_peak_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deconvoluted_peak_set</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dup</span>


<span class="k">class</span> <span class="nc">AveragedScan</span><span class="p">(</span><span class="n">WrappedScan</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">array_data</span><span class="p">,</span> <span class="n">scan_indices</span><span class="p">,</span> <span class="n">product_scans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">overrides</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AveragedScan</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">array_data</span><span class="p">,</span>
            <span class="n">product_scans</span><span class="o">=</span><span class="n">product_scans</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="n">annotations</span><span class="p">,</span> <span class="o">**</span><span class="n">overrides</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scan_indices</span> <span class="o">=</span> <span class="n">scan_indices</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrays</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scan_indices</span><span class="p">,</span>
            <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">product_scans</span><span class="p">],</span>
            <span class="n">annotations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_external_annotations</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_overrides</span><span class="p">)</span>
        <span class="n">dup</span><span class="o">.</span><span class="n">peak_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_set</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">dup</span><span class="o">.</span><span class="n">deconvoluted_peak_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deconvoluted_peak_set</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dup</span>


<div class="viewcode-block" id="PrecursorInformation"><a class="viewcode-back" href="../../../data_source/common_scan.html#ms_deisotope.data_source.common.PrecursorInformation">[docs]</a><span class="k">class</span> <span class="nc">PrecursorInformation</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Store information relating a tandem MS scan to its precursor MS scan.</span>

<span class="sd">    .. note:</span>
<span class="sd">        The attributes prefixed with `extracted_` refer to the quantities estimated</span>
<span class="sd">        from the data, while those unprefixed are the values read directly from the</span>
<span class="sd">        data source. These values regularly do not agree. When available, the extracted</span>
<span class="sd">        values should be more accurate.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    charge : int</span>
<span class="sd">        The charge reported in the source metadata</span>
<span class="sd">    defaulted : bool</span>
<span class="sd">        Whether the information in the extracted fields reflects empirical</span>
<span class="sd">        information or fell back on the vendor-reported values.</span>
<span class="sd">    extracted_charge : int</span>
<span class="sd">        The charge estimated from the source data</span>
<span class="sd">    extracted_intensity : float</span>
<span class="sd">        The sum of the peak heights of the extracted isotopic pattern</span>
<span class="sd">    extracted_neutral_mass : float</span>
<span class="sd">        The monoisotopic neutral mass estimated from the source data</span>
<span class="sd">    extracted_peak : :class:`.DeconvolutedPeak`</span>
<span class="sd">        The deconvoluted peak summarizing the precursor ion</span>
<span class="sd">    intensity : float</span>
<span class="sd">        The abundance reported in the source metadata</span>
<span class="sd">    mz : float</span>
<span class="sd">        The m/z reported in the source metadata</span>
<span class="sd">    orphan : bool</span>
<span class="sd">        Whether there was an isotopic pattern to extract in the precursor scan. Usually</span>
<span class="sd">        paired with `defaulted`</span>
<span class="sd">    peak : :class:`.FittedPeak`</span>
<span class="sd">        The peak nearest :attr:`mz`, and the starting point for estimating information</span>
<span class="sd">        about the precursor ion</span>
<span class="sd">    precursor_scan_id : str</span>
<span class="sd">        The id string for the precursor scan</span>
<span class="sd">    source : :class:`ScanIterator`</span>
<span class="sd">        Any object implementing the :class:`ScanIterator` interface to be used to look up</span>
<span class="sd">        the precursor scan with :attr:`precursor_scan_id`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mz</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">charge</span><span class="p">,</span> <span class="n">precursor_scan_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">extracted_neutral_mass</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">extracted_charge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">extracted_intensity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">peak</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extracted_peak</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">defaulted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">orphan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">product_scan_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">charge</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">extracted_charge</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">extracted_charge</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mz</span> <span class="o">=</span> <span class="n">mz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span> <span class="o">=</span> <span class="n">intensity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">precursor_scan_id</span> <span class="o">=</span> <span class="n">precursor_scan_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">extracted_neutral_mass</span> <span class="o">=</span> <span class="n">extracted_neutral_mass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extracted_charge</span> <span class="o">=</span> <span class="n">extracted_charge</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extracted_intensity</span> <span class="o">=</span> <span class="n">extracted_intensity</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">peak</span> <span class="o">=</span> <span class="n">peak</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extracted_peak</span> <span class="o">=</span> <span class="n">extracted_peak</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaulted</span> <span class="o">=</span> <span class="n">defaulted</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orphan</span> <span class="o">=</span> <span class="n">orphan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">product_scan_id</span> <span class="o">=</span> <span class="n">product_scan_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="n">annotations</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;PrecursorInformation(mz=</span><span class="si">%0.4f</span><span class="s2">/</span><span class="si">%0.4f</span><span class="s2">, intensity=</span><span class="si">%0.4f</span><span class="s2">/</span><span class="si">%0.4f</span><span class="s2">, charge=</span><span class="si">%r</span><span class="s2">/</span><span class="si">%r</span><span class="s2">, scan_id=</span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extracted_mz</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extracted_neutral_mass</span> <span class="o">!=</span> <span class="mf">0.</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extracted_intensity</span> <span class="ow">or</span> <span class="mf">0.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extracted_charge</span> <span class="ow">or</span> <span class="mf">0.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">precursor_scan_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">precursor_scan_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extracted_neutral_mass</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">extracted_charge</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extracted_intensity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extracted_peak</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">defaulted</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">orphan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">product_scan_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">precursor_scan_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extracted_neutral_mass</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">extracted_charge</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extracted_intensity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extracted_peak</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">defaulted</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">orphan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">product_scan_id</span><span class="p">)</span> <span class="o">=</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">precursor_scan_id</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">precursor_scan_id</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">eq</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">product_scan_id</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">product_scan_id</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">eq</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">self_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extracted_neutral_mass</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">other_fit</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">extracted_neutral_mass</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">self_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extracted_mz</span> <span class="k">if</span> <span class="n">self_fit</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz</span>
        <span class="n">other_mass</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">extracted_mz</span> <span class="k">if</span> <span class="n">other_fit</span> <span class="k">else</span> <span class="n">other</span><span class="o">.</span><span class="n">mz</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">self_mass</span><span class="p">,</span> <span class="n">other_mass</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">eq</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">self_charge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extracted_charge</span> <span class="k">if</span> <span class="n">self_fit</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge</span>
        <span class="n">other_charge</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">extracted_charge</span> <span class="k">if</span> <span class="n">other_fit</span> <span class="k">else</span> <span class="n">other</span><span class="o">.</span><span class="n">charge</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="n">self_charge</span> <span class="o">==</span> <span class="n">other_charge</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">eq</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">override_charge</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extracted_neutral_mass</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">neutral_mass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extracted_charge</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">peak</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span> <span class="k">if</span> <span class="n">override_charge</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">override_charge</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extracted_intensity</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">intensity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extracted_peak</span> <span class="o">=</span> <span class="n">peak</span>

    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orphan</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">==</span> <span class="n">ChargeNotProvided</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;A precursor has been defaulted with an unknown charge state.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extracted_charge</span> <span class="o">=</span> <span class="n">ChargeNotProvided</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extracted_neutral_mass</span> <span class="o">=</span> <span class="n">neutral_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">,</span> <span class="n">DEFAULT_CHARGE_WHEN_NOT_RESOLVED</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extracted_intensity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">defaulted</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extracted_charge</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extracted_neutral_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neutral_mass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extracted_intensity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">defaulted</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">orphan</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orphan</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">neutral_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">==</span> <span class="n">ChargeNotProvided</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;A precursor with an unknown charge state was used to compute a neutral mass.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">neutral_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">,</span> <span class="n">DEFAULT_CHARGE_WHEN_NOT_RESOLVED</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">neutral_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">extracted_mz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extracted_charge</span> <span class="o">==</span> <span class="n">ChargeNotProvided</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;A precursor with an unknown charge state was used to compute a m/z.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">mass_charge_ratio</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">,</span> <span class="n">DEFAULT_CHARGE_WHEN_NOT_RESOLVED</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mass_charge_ratio</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extracted_neutral_mass</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extracted_charge</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">precursor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">get_scan_by_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">precursor_scan_id</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">product</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">get_scan_by_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">product_scan_id</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">ProcessedScan</span><span class="p">(</span><span class="n">ScanBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">precursor_information</span><span class="p">,</span>
                 <span class="n">ms_level</span><span class="p">,</span> <span class="n">scan_time</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">peak_set</span><span class="p">,</span>
                 <span class="n">deconvoluted_peak_set</span><span class="p">,</span> <span class="n">polarity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">acquisition_information</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">isolation_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">instrument_configuration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">product_scans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">annotations</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">product_scans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">product_scans</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">annotations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">annotations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precursor_information</span> <span class="o">=</span> <span class="n">precursor_information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ms_level</span> <span class="o">=</span> <span class="n">ms_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scan_time</span> <span class="o">=</span> <span class="n">scan_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak_set</span> <span class="o">=</span> <span class="n">peak_set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deconvoluted_peak_set</span> <span class="o">=</span> <span class="n">deconvoluted_peak_set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">polarity</span> <span class="o">=</span> <span class="n">polarity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="n">activation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_information</span> <span class="o">=</span> <span class="n">acquisition_information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isolation_window</span> <span class="o">=</span> <span class="n">isolation_window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instrument_configuration</span> <span class="o">=</span> <span class="n">instrument_configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">product_scans</span> <span class="o">=</span> <span class="n">product_scans</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="n">annotations</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak_set</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deconvoluted_peak_set</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_information</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isolation_window</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instrument_configuration</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">product_scans</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scan_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deconvoluted_peak_set</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">deconvoluted_peak_set</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">has_peak</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">error_tolerance</span><span class="o">=</span><span class="mf">2e-5</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">deconvoluted_peak_set</span><span class="o">.</span><span class="n">has_peak</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">error_tolerance</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deconvoluted_peak_set</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">peaks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deconvoluted_peak_set</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_set</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">peaks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_set</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">peaks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">pinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">precursor_information</span>
        <span class="k">if</span> <span class="n">pinfo</span><span class="p">:</span>
            <span class="n">pinfo_string</span> <span class="o">=</span> <span class="s2">&quot;, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pinfo</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pinfo_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">return</span> <span class="s2">&quot;ProcessedScan(id=</span><span class="si">%s</span><span class="s2">, ms_level=</span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2"> peaks</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms_level</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">),</span> <span class="n">pinfo_string</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">precursor_information</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms_level</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scan_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_set</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deconvoluted_peak_set</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">polarity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_information</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isolation_window</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument_configuration</span><span class="p">,</span>
            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">product_scans</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">dup</span>


<span class="k">class</span> <span class="nc">IteratorFacadeBase</span><span class="p">(</span><span class="n">DataAccessProxy</span><span class="p">,</span> <span class="n">ScanIterator</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">DataAccessProxy</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_producer</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">make_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grouped</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">grouped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_producer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">_scan_group_iterator</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_producer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">_single_scan_iterator</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan_bunch</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">scan_bunch</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_producer</span><span class="p">))</span>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Joshua Klein.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.4.
    </div>
  </body>
</html>